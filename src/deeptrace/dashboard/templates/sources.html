<div class="section-header">
  <h1 class="section-title">Sources</h1>
  <button class="btn btn-primary" aria-expanded="false" aria-controls="add-source-form" onclick="var f=document.getElementById('add-source-form'); var show=f.style.display==='none'; f.style.display=show?'block':'none'; this.setAttribute('aria-expanded', show)">+ Add Source</button>
</div>

<div id="add-source-form" class="add-form-container" style="display:none">
  <form class="add-form" hx-post="/sources" hx-target="#main-content" hx-swap="innerHTML">

    <!-- URL Fetch Row -->
    <div class="form-row" style="align-items:flex-end">
      <div class="form-group" style="flex:1">
        <label for="source-url">URL <span style="color:var(--text-dim);font-weight:normal">(paste and click Fetch to auto-fill)</span></label>
        <input type="text" name="url" id="source-url" placeholder="https://...">
      </div>
      <div class="form-group" style="max-width:100px">
        <button type="button" class="btn btn-primary" onclick="fetchSourceUrl()" id="fetch-btn">Fetch</button>
      </div>
    </div>

    <!-- Fetch status message -->
    <div id="fetch-status" style="display:none;padding:8px 12px;border-radius:6px;margin-bottom:12px;font-size:13px"></div>

    <!-- Paste fallback (shown on 403) -->
    <div id="paste-fallback" class="form-row" style="display:none">
      <div class="form-group">
        <label for="paste-html">Paste Page HTML <span style="color:var(--text-dim);font-weight:normal">(Ctrl+U in your browser to view source)</span></label>
        <textarea id="paste-html" rows="4" placeholder="Paste the page HTML source here..."></textarea>
        <button type="button" class="btn btn-primary btn-sm" style="margin-top:6px" onclick="fetchFromPaste()">Extract from Paste</button>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="source-type">Source Type</label>
        <select name="source_type" id="source-type">
          <option value="news">News</option>
          <option value="official">Official</option>
          <option value="social">Social</option>
          <option value="document">Document</option>
          <option value="manual" selected>Manual</option>
        </select>
      </div>
      <div class="form-group" style="max-width:180px">
        <label for="source-reliability-grade">Source Reliability</label>
        <select name="source_reliability" id="source-reliability-grade">
          <option value="">-- Not rated --</option>
          <option value="A">A - Completely reliable</option>
          <option value="B">B - Usually reliable</option>
          <option value="C">C - Fairly reliable</option>
          <option value="D">D - Not usually reliable</option>
          <option value="E">E - Unreliable</option>
          <option value="F">F - Cannot be judged</option>
        </select>
      </div>
      <div class="form-group" style="max-width:180px">
        <label for="source-info-accuracy">Info Accuracy</label>
        <select name="information_accuracy" id="source-info-accuracy">
          <option value="">-- Not rated --</option>
          <option value="1">1 - Confirmed</option>
          <option value="2">2 - Probably true</option>
          <option value="3">3 - Possibly true</option>
          <option value="4">4 - Doubtful</option>
          <option value="5">5 - Improbable</option>
          <option value="6">6 - Cannot be judged</option>
        </select>
      </div>
      <div class="form-group" style="max-width:100px">
        <label for="source-reliability">Score</label>
        <input type="number" name="reliability_score" id="source-reliability" value="0.5" min="0" max="1" step="0.01">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="source-raw-text">Text / Summary</label>
        <textarea name="raw_text" id="source-raw-text" rows="4" required placeholder="Source text or summary..."></textarea>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="source-notes">Notes</label>
        <input type="text" name="notes" id="source-notes" placeholder="Optional notes">
      </div>
    </div>
    <div class="flex gap-8">
      <button type="submit" class="btn btn-primary">Add Source</button>
      <button type="button" class="btn btn-ghost" onclick="document.getElementById('add-source-form').style.display='none'">Cancel</button>
    </div>
  </form>
</div>

<div class="panel">
  <table class="data-table">
    <thead>
      <tr>
        <th scope="col" class="id-col">#</th>
        <th scope="col" class="type-col">Type</th>
        <th scope="col">Text</th>
        <th scope="col" style="width:60px">Rating</th>
        <th scope="col" style="width:60px">Score</th>
        <th scope="col" style="width:100px">Date</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sources %}
      <tr hx-get="/sources/{{ s.id }}" hx-target="#detail-panel" hx-swap="innerHTML" tabindex="0">
        <td class="id-col">{{ s.id }}</td>
        <td class="type-col"><span class="badge">{{ s.source_type }}</span></td>
        <td class="text-truncate" style="max-width:400px">{{ s.raw_text[:100] }}{% if s.raw_text|length > 100 %}...{% endif %}</td>
        <td>
          {% if s.source_reliability and s.information_accuracy %}
            <span style="font-weight:600">{{ s.source_reliability }}{{ s.information_accuracy }}</span>
          {% elif s.source_reliability %}
            {{ s.source_reliability }}-
          {% else %}
            <span style="color:var(--text-dim)">--</span>
          {% endif %}
        </td>
        <td>{{ "%.2f"|format(s.reliability_score) }}</td>
        <td style="color:var(--text-dim);font-size:12px">{{ s.ingested_at[:10] if s.ingested_at else '' }}</td>
      </tr>
      {% endfor %}
      {% if not sources %}
      <tr><td colspan="6" style="color:var(--text-dim);text-align:center;padding:20px">No sources yet. Paste a URL above and click Fetch to import.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
function showFetchStatus(msg, isError) {
  var el = document.getElementById('fetch-status');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.background = isError ? 'rgba(239,68,68,0.15)' : 'rgba(59,130,246,0.15)';
  el.style.color = isError ? 'var(--accent-red, #ef4444)' : 'var(--accent-blue, #3b82f6)';
}

function hideFetchStatus() {
  document.getElementById('fetch-status').style.display = 'none';
}

function fillFormFromFetch(data) {
  if (data.source_type) {
    var sel = document.getElementById('source-type');
    for (var i = 0; i < sel.options.length; i++) {
      if (sel.options[i].value === data.source_type) { sel.selectedIndex = i; break; }
    }
  }
  if (data.source_reliability) {
    var rel = document.getElementById('source-reliability-grade');
    for (var i = 0; i < rel.options.length; i++) {
      if (rel.options[i].value === data.source_reliability) { rel.selectedIndex = i; break; }
    }
  }
  if (data.information_accuracy) {
    var acc = document.getElementById('source-info-accuracy');
    for (var i = 0; i < acc.options.length; i++) {
      if (acc.options[i].value === data.information_accuracy) { acc.selectedIndex = i; break; }
    }
  }
  if (data.reliability_score !== undefined) {
    document.getElementById('source-reliability').value = data.reliability_score;
  }
  if (data.raw_text) {
    document.getElementById('source-raw-text').value = data.raw_text;
  }
  if (data.notes) {
    document.getElementById('source-notes').value = data.notes;
  }
  showFetchStatus('Fields auto-filled from URL. Review and click "Add Source" to save.', false);
}

function fetchSourceUrl() {
  var url = document.getElementById('source-url').value.trim();
  if (!url) { showFetchStatus('Please enter a URL first.', true); return; }

  var btn = document.getElementById('fetch-btn');
  btn.disabled = true;
  btn.textContent = 'Fetching...';
  hideFetchStatus();
  document.getElementById('paste-fallback').style.display = 'none';

  fetch('/sources/fetch-url', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: url })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    btn.disabled = false;
    btn.textContent = 'Fetch';

    if (data.error) {
      showFetchStatus(data.error, true);
      if (data.needs_paste) {
        document.getElementById('paste-fallback').style.display = 'flex';
      }
      return;
    }

    if (data.status === 'ok') {
      fillFormFromFetch(data);
    }
  })
  .catch(function(err) {
    btn.disabled = false;
    btn.textContent = 'Fetch';
    showFetchStatus('Network error: ' + err.message, true);
  });
}

function fetchFromPaste() {
  var url = document.getElementById('source-url').value.trim();
  var html = document.getElementById('paste-html').value.trim();
  if (!html) { showFetchStatus('Please paste the page HTML first.', true); return; }

  showFetchStatus('Extracting from pasted HTML...', false);

  fetch('/sources/fetch-url', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: url, html: html })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) {
      showFetchStatus(data.error, true);
      return;
    }
    if (data.status === 'ok') {
      fillFormFromFetch(data);
      document.getElementById('paste-fallback').style.display = 'none';
    }
  })
  .catch(function(err) {
    showFetchStatus('Error: ' + err.message, true);
  });
}

/* Auto-compute numeric score when Admiralty dropdowns change */
document.getElementById('source-reliability-grade').addEventListener('change', updateScore);
document.getElementById('source-info-accuracy').addEventListener('change', updateScore);

function updateScore() {
  var relMap = { A: 1.0, B: 0.8, C: 0.6, D: 0.4, E: 0.2, F: 0.0 };
  var accMap = { '1': 1.0, '2': 0.8, '3': 0.6, '4': 0.4, '5': 0.2, '6': 0.0 };
  var r = document.getElementById('source-reliability-grade').value;
  var a = document.getElementById('source-info-accuracy').value;
  if (r && a) {
    var score = ((relMap[r] || 0.4) + (accMap[a] || 0.4)) / 2;
    document.getElementById('source-reliability').value = score.toFixed(2);
  }
}
</script>
